import{s as a}from"./utils.js";import{t as c}from"./toggleAccent.js";class d{constructor(t,e,s){this.form=document.getElementById(t),this.fileInput=document.getElementById(e),this.serverError=document.getElementById(s),this.infoMessage=document.getElementById("server-info"),this.errorMessage=document.getElementById("errorMessage"),this.initAccordion(),this.initWebSocket(),this.initFileUpload()}initAccordion(){document.querySelectorAll(".accordion-toggle").forEach(t=>{t.addEventListener("click",()=>{const e=t.nextElementSibling,s=t.querySelector("svg"),o=e.classList.contains("max-h-600");document.querySelectorAll(".accordion-content").forEach(i=>i.classList.remove("max-h-600")),document.querySelectorAll(".accordion-toggle svg").forEach(i=>i.classList.remove("rotate-180")),setTimeout(()=>{o||(e.classList.add("max-h-600"),s.classList.add("rotate-180"))},500)})})}initWebSocket(){const e=`${window.location.protocol==="https:"?"wss":"ws"}://${window.location.host}/ws/upload/`;this.socket=new WebSocket(e),this.socket.onopen=()=>{console.log("WebSocket подключен")},this.socket.onmessage=s=>{const o=JSON.parse(s.data);console.log("Прогресс с сервера:",o),this.updateProgress(o)},this.socket.onclose=s=>{console.log("WebSocket закрыт",s)},this.socket.onerror=s=>{console.error("Ошибка WebSocket:",s)}}updateProgress(t){const e=document.getElementById("upload-progress-container"),s=document.getElementById("upload-progress-bar"),o=document.getElementById("upload-progress-text");e&&s&&o&&(e.classList.remove("hidden"),s.style.width=`${t}%`,o.textContent=`Файл обработан на ${t}%`),t>=100&&(this.showSuccessMessage("Обработка успешно завершена!"),this.fileInput.value="",setTimeout(()=>{e.classList.add("hidden"),s.style.width="0%",o.textContent="0%"},2e3))}initFileUpload(){this.form.addEventListener("submit",async t=>{t.preventDefault();const e=this.fileInput.files[0];if(!e||e.name!=="globus.docx"){this.errorMessage.classList.remove("hidden"),a("Нужно добавить файл с названием globus.docx!!!"),this.fileInput.classList.remove("correct_input"),this.fileInput.classList.add("error_input"),setTimeout(()=>{this.fileInput.classList.add("correct_input"),this.fileInput.classList.remove("error_input"),this.errorMessage.classList.add("hidden")},4e3);return}else this.errorMessage.classList.add("hidden");const s=new FormData;s.append("cityFile",e);const o=document.querySelector("[name=csrfmiddlewaretoken]").value;try{const i=await fetch(this.form.action,{method:"POST",headers:{"X-CSRFToken":o},body:s}),n=await i.json();if(i.ok){const r=n.message||"Файл успешно загружен";console.log(r)}else a(n.error||"Ошибка загрузки файла")}catch(i){alert("Произошла ошибка при отправке файла"),console.error(i)}})}showSuccessMessage(t){const e=this.infoMessage;e.classList.remove("hidden","animate-popup-reverse"),e.classList.add("flex","animate-popup"),e.querySelector("p").textContent=t,setTimeout(()=>{e.classList.remove("animate-popup"),e.classList.add("animate-popup-reverse"),setTimeout(()=>{e.classList.add("hidden"),e.classList.remove("flex","animate-popup-reverse")},1e3)},4e3)}}class h{constructor(t){this.form=document.getElementById(t),this.dockInput=this.form.querySelector("#dock-num"),this.tableSelect=this.form.querySelector("#table-name"),this.closeModalBtn=document.getElementById("close-modal"),this.saveCity=document.getElementById("save-city"),this.isEditMode=!1,this.csrfToken=document.querySelector("[name=csrfmiddlewaretoken]").value,this.infoMessage=document.getElementById("server-info"),this.fields={location:this.form.querySelector("#location"),name_organ:this.form.querySelector("#name-organ"),pseudonim:this.form.querySelector("#pseudonim"),letters:this.form.querySelector("#letters"),writing:this.form.querySelector("#writing"),ip_address:this.form.querySelector("#ip-address"),some_number:this.form.querySelector("#some-number"),work_time:this.form.querySelector("#work-time")},this.init(),this.initCancelButton(),this.initSaveButton()}init(){this.dockInput.addEventListener("input",()=>this.handleDockNumInput(!1)),this.tableSelect.addEventListener("change",()=>this.handleDockNumInput())}async handleDockNumInput(t=!0){const e=this.tableSelect.value;if(!e){this.clearFields();return}const s=t?"":this.dockInput.value;if(!t&&s.trim()===""){this.clearFields();return}try{const i=await(await fetch(`city-info/?dock_num=${s}&table_id=${e}`)).json();i.found?(this.fillFields(i.data),this.saveCity.textContent="Сохранить изменения",this.isEditMode=!0,t&&(this.dockInput.value=i.data.dock_num||"")):i.last_num?(t&&(this.dockInput.value=i.last_num,this.clearFields()),this.saveCity.textContent="Создать запись",this.isEditMode=!1):(this.saveCity.textContent="Создать запись",this.clearFields(),this.isEditMode=!1)}catch(o){console.error("Ошибка при получении данных:",o)}}initSaveButton(){this.saveCity.addEventListener("click",async()=>{if(!this.tableSelect.value){a("Пожалуйста, выберите название таблицы"),this.tableSelect.focus();return}const t=this.isEditMode?"PUT":"POST",e="city-info/",s={dock_num:this.dockInput.value,table_id:this.tableSelect.value,location:this.fields.location.value,name_organ:this.fields.name_organ.value,pseudonim:this.fields.pseudonim.value,letters:this.fields.letters.checked,writing:this.fields.writing.checked,ip_address:this.fields.ip_address.value,some_number:this.fields.some_number.value,work_time:this.fields.work_time.value};try{const o=await fetch(e,{method:t,headers:{"Content-Type":"application/json","X-CSRFToken":this.csrfToken},body:JSON.stringify(s)});if(o.ok)this.showSuccessMessage(`Данные успешно сохранены для записи №${s.dock_num}${s.name_organ?" - "+s.name_organ:""}${s.location?" - "+s.location:""}`),this.form.reset(),this.saveCity.textContent="Сохранить",this.isEditMode=!1;else{const i=await o.json();let n="";for(const r in i.errors)n+=`${r}: ${i.errors[r].join(", ")}
`;a(`Ошибка при сохранении:
`+n)}}catch(o){console.error("Ошибка при отправке формы:",o)}})}fillFields(t){this.fields.location.value=t.location||"",this.fields.name_organ.value=t.name_organ||"",this.fields.pseudonim.value=t.pseudonim||"",this.fields.letters.checked=t.letters??!1,this.fields.writing.checked=t.writing??!1,this.fields.ip_address.value=t.ip_address||"",this.fields.some_number.value=t.some_number||"",this.fields.work_time.value=t.work_time||""}clearFields(){Object.entries(this.fields).forEach(([t,e])=>{e.type==="checkbox"?e.checked=!1:e.value=""})}initCancelButton(){this.closeModalBtn&&this.closeModalBtn.addEventListener("click",()=>{this.form.reset(),this.saveCity.textContent="Сохранить",this.isEditMode=!1})}showSuccessMessage(t){const e=this.infoMessage;e.classList.remove("hidden","animate-popup-reverse"),e.classList.add("flex","animate-popup"),e.querySelector("p").textContent=t,e.scrollIntoView({behavior:"smooth",block:"start"}),setTimeout(()=>{e.classList.remove("animate-popup"),e.classList.add("animate-popup-reverse"),e.scrollIntoView({behavior:"smooth",block:"start"}),setTimeout(()=>{e.classList.add("hidden"),e.classList.remove("flex","animate-popup-reverse")},1e3)},4e3)}}document.addEventListener("DOMContentLoaded",()=>{c("a-admin","a-admin-mob"),new d("uploadForm","fileInput","server-error"),new h("updateFormCities")});
