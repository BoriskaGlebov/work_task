/* empty css        */import{t as u}from"./toggleAccent.js";import{s as l}from"./utils.js";class g{constructor(e,t,s=[]){if(this.input=document.getElementById(e),this.suggestions=document.getElementById(t),this.counter=document.getElementById("counter"),this.citiesData=s,this.selectedIndex=-1,this.renderedCities=[],this.remainingCities=[],this.renderingCancelled=!1,this.observer=null,!this.input||!this.suggestions){console.warn("CityAutocomplete: Элементы не найдены на странице.");return}this.bindEvents()}bindEvents(){this.input.addEventListener("input",()=>this.handleInput()),this.input.addEventListener("keydown",e=>this.handleKeyDown(e)),document.addEventListener("click",e=>this.handleDocumentClick(e))}clearSelection(){this.suggestions.querySelectorAll("li").forEach(e=>e.classList.remove("bg-gray-300")),this.selectedIndex=-1}async loadMoreCities(e=10,t=100){var n;const s=this.remainingCities.splice(0,e),i=[];for(const a of s){if(this.renderingCancelled)return;this.createCityCard(a),i.push(a),await new Promise(o=>setTimeout(o,t))}i.length>0&&await this.sendRenderedCityStats(i),this.remainingCities.length===0&&((n=this.observer)==null||n.disconnect())}observeScroll(){const e=document.getElementById("city-cards");if(!e||document.getElementById("scroll-sentinel"))return;const t=document.createElement("div");t.id="scroll-sentinel",e.appendChild(t),this.observer=new IntersectionObserver(([s])=>{s.isIntersecting&&this.remainingCities.length&&this.loadMoreCities()},{root:null,threshold:.1}),this.observer.observe(t)}highlightItem(e){const t=this.suggestions.querySelectorAll("li");if(!t.length)return;this.clearSelection();const s=(e+t.length)%t.length;t[s].classList.add("bg-gray-300"),t[s].scrollIntoView({block:"nearest"}),this.selectedIndex=s}createCityCard(e){const t=document.getElementById("city-cards");if(!t)return;const s=document.createElement("div");s.classList.add("card-style"),s.style.cursor="pointer",s.dataset.city=JSON.stringify(e);const i=[["Организация",e.name_organ],["Псевдоним",e.pseudonim],["Время работы",e.work_time],["Название раздела",e.table_name],["Номер в таблице",e.some_number],["IP address",e.ip_address]];s.innerHTML=`<h3 class="text-lg font-semibold mb-2 text-center">${e.location||"Неизвестно"}</h3>`+i.filter(([a,o])=>o).map(([a,o])=>`<p><strong>${a}:</strong> ${o}</p>`).join("");const n=document.getElementById("scroll-sentinel");t.insertBefore(s,n||null)}clearCityCards(){var e;(e=document.getElementById("city-cards"))==null||e.replaceChildren()}async renderCardsWithDelay(e,t=100){this.cancelRendering(),this.clearCityCards(),this.renderingCancelled=!1,this.renderedCities=e.slice(0,10),this.remainingCities=e.slice(10);for(const s of this.renderedCities){if(this.renderingCancelled)return;this.createCityCard(s),await new Promise(i=>setTimeout(i,t))}await this.sendRenderedCityStats(this.renderedCities),this.observeScroll()}cancelRendering(){var e,t;this.renderingCancelled=!0,(e=this.observer)==null||e.disconnect(),(t=document.getElementById("scroll-sentinel"))==null||t.remove()}handleInput(){var s,i;const e=this.input.value.trim().toLowerCase();if(this.cancelRendering(),this.clearSelection(),this.clearCityCards(),this.suggestions.innerHTML="",!e){this.suggestions.style.display="none",(s=this.counter)==null||s.classList.add("opacity-0");return}const t=this.citiesData.filter(n=>n.location&&n.location.toLowerCase().includes(e)||n.name_organ&&n.name_organ.toLowerCase().includes(e)||n.pseudonim&&n.pseudonim.toLowerCase().includes(e));if((i=this.counter)==null||i.classList.remove("opacity-0"),this.counter&&(this.counter.textContent=`Найдено совпадений: ${t.length}`),!t.length){this.suggestions.style.display="none";return}t.slice(0,20).forEach(n=>{const a=document.createElement("li");a.classList.add("cursor-pointer","px-3","py-1","hover:bg-gray-200"),a.textContent=`${n.location||""}${n.name_organ?` — ${n.name_organ}`:""}${n.pseudonim?` — (${n.pseudonim})`:""}`,a.addEventListener("click",()=>{this.input.value=`${n.location} - ${n.name_organ||""} - ${n.pseudonim||""}`,this.suggestions.style.display="none",this.clearCityCards(),this.cancelRendering(),this.createCityCard(n),this.sendRenderedCityStats([n])}),this.suggestions.appendChild(a)}),this.suggestions.style.display="block"}handleKeyDown(e){const t=this.suggestions.querySelectorAll("li");if(t.length)switch(e.key){case"ArrowDown":e.preventDefault(),this.highlightItem(this.selectedIndex+1);break;case"ArrowUp":e.preventDefault(),this.highlightItem(this.selectedIndex-1);break;case"Enter":if(e.preventDefault(),this.selectedIndex>=0)t[this.selectedIndex].click();else{const s=this.input.value.trim().toLowerCase();if(!s)return;const i=this.citiesData.filter(n=>n.location&&n.location.toLowerCase().includes(s)||n.name_organ&&n.name_organ.toLowerCase().includes(s)||n.pseudonim&&n.pseudonim.toLowerCase().includes(s));this.renderCardsWithDelay(i),this.suggestions.style.display="none"}break;case"Escape":this.cancelRendering(),this.suggestions.style.display="none",this.clearSelection(),this.clearCityCards();break}}handleDocumentClick(e){!this.input.contains(e.target)&&!this.suggestions.contains(e.target)&&(this.suggestions.style.display="none",this.clearSelection())}async sendRenderedCityStats(e){const t=e.map(i=>i.table_id).filter(Boolean),s=e.map(i=>i.dock_num).filter(Boolean);if(t.length)try{await fetch("api/city-counter/",{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":this.getCSRFToken()},body:JSON.stringify({table_ids:t,dock_num:s})})}catch(i){l("Ошибка отправки статистики:",i),console.error("Ошибка отправки статистики:",i)}}getCSRFToken(){const e=document.cookie.match(/csrftoken=([\w-]+)/);return e?e[1]:""}}class p{constructor(e,t=[]){var s,i,n,a;this.modal=document.getElementById(e),this.form=(s=this.modal)==null?void 0:s.querySelector("form"),this.saveBtn=(i=this.modal)==null?void 0:i.querySelector("#save-city"),this.deleteBtn=(n=this.modal)==null?void 0:n.querySelector("#delete-city"),this.closeBtn=(a=this.modal)==null?void 0:a.querySelector("#close-modal"),this.csrfToken=document.querySelector("[name=csrfmiddlewaretoken]").value,this.currentCity=null,this.citiesData=t,this.bindEvents(),this.observeCards()}bindEvents(){var e,t,s;(e=this.closeBtn)==null||e.addEventListener("click",()=>this.hideModal()),(t=this.saveBtn)==null||t.addEventListener("click",async()=>{if(!this.currentCity)return;const i=this.getFormData();await this.updateCity(this.currentCity,i),this.hideModal()}),(s=this.deleteBtn)==null||s.addEventListener("click",async()=>{this.currentCity&&(await this.deleteCity(this.currentCity),this.hideModal())}),window.addEventListener("click",i=>{var o;if(!this.modal||this.modal.classList.contains("hidden"))return;const n=!((o=this.modal.querySelector("form"))!=null&&o.contains(i.target)),a=this.modal.contains(i.target);n&&a&&this.hideModal()}),window.addEventListener("keydown",i=>{i.key==="Escape"&&!this.modal.classList.contains("hidden")&&this.hideModal()})}observeCards(){document.addEventListener("click",e=>{const t=e.target.closest(".card-style");if(!t)return;const s=t.dataset.city?JSON.parse(t.dataset.city):null;s&&this.showModal(s)})}showModal(e){var t;this.currentCity=e,this.modal&&(this.modal.querySelector("#modal-location").value=e.location||"",this.modal.querySelector("#modal-name_organ").value=e.name_organ||"",this.modal.querySelector("#modal-pseudonim").value=e.pseudonim||"",this.modal.querySelector("#modal-work_time").value=e.work_time||"",this.modal.querySelector("#modal-table_name").value=e.table_name||"",this.modal.querySelector("#modal-number").value=e.dock_num||"",this.modal.querySelector("#modal-some_number").value=e.some_number||"",this.modal.querySelector("#modal-ip_address").value=e.ip_address||"",this.modal.classList.remove("hidden"),(t=this.form)==null||t.classList.add("animate-popup"))}hideModal(){var e;(e=this.modal)==null||e.classList.add("hidden"),this.currentCity=null}getFormData(){var e;return{location:this.modal.querySelector("#modal-location").value.trim(),name_organ:this.modal.querySelector("#modal-name_organ").value.trim(),pseudonim:this.modal.querySelector("#modal-pseudonim").value.trim(),work_time:this.modal.querySelector("#modal-work_time").value.trim(),table_name:this.modal.querySelector("#modal-table_name").value.trim(),some_number:this.modal.querySelector("#modal-some_number").value.trim(),ip_address:this.modal.querySelector("#modal-ip_address").value.trim(),table_id:((e=this.currentCity)==null?void 0:e.table_id)||null}}async updateCity(e,t){try{const s=await fetch(`cities/${e.table_id}/${e.dock_num}/`,{method:"PUT",headers:{"Content-Type":"application/json","X-CSRFToken":this.csrfToken},body:JSON.stringify(t)});if(!s.ok){const o=await s.json().catch(()=>null);l((o==null?void 0:o.message)||"Ошибка при обновлении города");return}const i=this.citiesData.findIndex(o=>o.table_id===e.table_id&&o.dock_num===e.dock_num);i!==-1&&Object.assign(this.citiesData[i],t),Object.assign(e,t);const a=document.getElementById("city-cards").querySelectorAll(".card-style");document.getElementById("default-search").value="";for(const o of a){const r=JSON.parse(o.dataset.city||"{}");if(r.table_id===e.table_id&&r.dock_num===e.dock_num){o.dataset.city=JSON.stringify(e);const c=[["Организация",e.name_organ],["Псевдоним",e.pseudonim],["Время работы",e.work_time],["Название раздела",e.table_name],["Номер в таблице",e.some_number],["IP address",e.ip_address]];o.innerHTML=`<h3 class="text-lg font-semibold mb-2 text-center">${e.location||"Неизвестно"}</h3>`+c.filter(([m,h])=>h).map(([m,h])=>`<p><strong>${m}:</strong> ${h}</p>`).join("");break}}this.showSuccessMessage(`Город "${t.name_organ}" успешно обновлён`)}catch(s){console.error("Ошибка PUT-запроса:",s),l(s)}}async deleteCity(e){if(await this.showDeleteConfirmation(e))try{const s=await fetch(`cities/${e.table_id}/${e.dock_num}/`,{method:"DELETE",headers:{"Content-Type":"application/json","X-CSRFToken":this.csrfToken}});if(!s.ok){const o=await s.json().catch(()=>null);l((o==null?void 0:o.message)||"Ошибка при удалении города");return}const i=this.citiesData.findIndex(o=>o.table_id===e.table_id&&o.dock_num===e.dock_num);i!==-1&&this.citiesData.splice(i,1);const a=document.getElementById("city-cards").querySelectorAll(".card-style");document.getElementById("default-search").value="";for(const o of a){const r=JSON.parse(o.dataset.city||"{}");if(r.table_id===e.table_id&&r.dock_num===e.dock_num){o.remove();break}}this.showSuccessMessage(`Город "${e.name_organ}" успешно удалён`),this.hideModal()}catch(s){console.error("Ошибка DELETE-запроса:",s),l(s)}}showSuccessMessage(e){const t=document.getElementById("server-info");t.classList.remove("hidden","animate-popup-reverse"),t.classList.add("flex","animate-popup"),t.querySelector("p").textContent=e,t.scrollIntoView({behavior:"smooth",block:"start"}),setTimeout(()=>{t.classList.remove("animate-popup"),t.classList.add("animate-popup-reverse"),setTimeout(()=>{t.classList.add("hidden"),t.classList.remove("flex","animate-popup-reverse")},1e3)},5e3)}showDeleteConfirmation(e){return new Promise(t=>{const s=document.getElementById("server-info");s.classList.remove("hidden","animate-popup-reverse"),s.classList.add("flex","animate-popup"),s.querySelector("h3").textContent="Подтверждение удаления",s.querySelector("p").textContent=`Вы уверены, что хотите удалить "${e.name_organ}"?`,s.scrollIntoView({behavior:"smooth",block:"start"});const i=document.getElementById("btn-div");i.innerHTML="";const n=document.createElement("button");n.id="confirm-delete",n.textContent="Удалить",n.classList.add("btn-submit","!p-1","!font-medium");const a=document.createElement("button");a.id="cancel-delete",a.textContent="Отмена",a.classList.add("btn-cancel","!p-1","!font-medium"),i.appendChild(n),i.appendChild(a);let o=!1;const r=()=>new Promise(m=>{s.classList.remove("animate-popup"),s.classList.add("animate-popup-reverse"),setTimeout(()=>{i.innerHTML="",s.querySelector("h3").textContent="",s.querySelector("p").textContent="",s.classList.add("hidden"),m()},1e3)}),c=setTimeout(()=>{o||(o=!0,r().then(()=>t(!1)))},5e3);n.addEventListener("click",()=>{o||(o=!0,clearTimeout(c),r().then(()=>t(!0)))}),a.addEventListener("click",()=>{o||(o=!0,clearTimeout(c),r().then(()=>t(!1)))})})}}document.addEventListener("DOMContentLoaded",()=>{u("a-cities","a-cities-mob"),console.log(citiesData);const d=citiesData;new g("default-search","suggestions",d),new p("city-modal",d)});
