/* empty css        */import{t as y}from"../../cities/js/toggleAccent.js";import{s as k}from"./utils.js";class x{constructor({addButtonId:t,boardId:o,colors:e=[]}){this.addCardBtn=document.getElementById(t),this.noteBoard=document.getElementById(o),this.csrfToken=document.querySelector("[name=csrfmiddlewaretoken]").value,this.colors=e.length?e:["#FFEB3B","#FFCDD2","#C8E6C9","#BBDEFB","#FFF9C4","#FFE0B2"],this.noteBoard.classList.add("relative"),this.addCardBtn.addEventListener("click",()=>this.showColorPicker()),this.draggedNote=null,this.dragOffsetX=0,this.dragOffsetY=0,this.authors=[username,...username_data.filter(s=>s.username!==username&&s.first_name!==username).map(s=>s.first_name.trim()!==""?s.first_name:s.username),"Всем!"],this.currentAuthorIndex=0,this.noteData=notes_data,this.onMouseMove=this.onMouseMove.bind(this),this.onMouseUp=this.onMouseUp.bind(this)}loadInitialNotes(){Array.isArray(this.noteData)&&this.noteData.forEach(t=>this.createNoteFromData(t))}showColorPicker(){if(document.getElementById("color-picker"))return;const t=document.createElement("div");t.id="color-picker",t.className="fixed bottom-25 right-7 bg-white p-2.5 rounded-lg shadow-md flex gap-2.5 z-[9999]",this.colors.forEach(e=>{const s=document.createElement("div");s.style.backgroundColor=e,s.className="w-7.5 h-7.5 rounded-md cursor-pointer",s.title=e,s.addEventListener("click",()=>{this.addNoteCard(e),t.remove()}),t.appendChild(s)}),document.body.appendChild(t);const o=e=>{t.contains(e.target)||(t.remove(),document.removeEventListener("click",o))};setTimeout(()=>document.addEventListener("click",o),0)}observeNoteResize(t){new ResizeObserver(()=>{const e=t.offsetTop+t.offsetHeight,s=this.noteBoard.offsetHeight;e+20>s&&(this.noteBoard.style.height=`${e+20}px`)}).observe(t)}onMouseDown(t,o){if(t.target.classList.contains("delete-btn"))return;const e=o.getBoundingClientRect(),s=t.clientX-e.left,r=t.clientY-e.top;s>e.width-20&&r>e.height-20||(t.preventDefault(),this.draggedNote=o,this.dragOffsetX=s,this.dragOffsetY=r,document.addEventListener("mousemove",this.onMouseMove),document.addEventListener("mouseup",this.onMouseUp),o.classList.add("dragging"))}onMouseMove(t){if(!this.draggedNote)return;t.preventDefault();const o=this.noteBoard.getBoundingClientRect();let e=t.clientX-o.left-this.dragOffsetX,s=t.clientY-o.top-this.dragOffsetY;const r=o.width-this.draggedNote.offsetWidth,d=o.height-this.draggedNote.offsetHeight;e=Math.min(Math.max(0,e),r),s=Math.min(Math.max(0,s),d),this.draggedNote.style.left=`${e}px`,this.draggedNote.style.top=`${s}px`}onMouseUp(t){this.draggedNote&&(document.removeEventListener("mousemove",this.onMouseMove),document.removeEventListener("mouseup",this.onMouseUp),this.draggedNote.classList.remove("dragging"),this.sendNoteUpdate(this.draggedNote),this.draggedNote=null)}buildNoteCard(t,o,e){const{id:s,text:r="Новая заметка...",color:d="#FFEB3B",position_top:m=100,position_left:u=100,author:a=this.authors[0],user:i}=t,n=document.createElement("div");n.classList.add("note-card"),n.style.backgroundColor=d,n.style.position="absolute",n.style.top=`${m}px`,n.style.left=`${u}px`,s!==void 0&&n.setAttribute("data-id",s),i!==void 0&&n.setAttribute("data-user",i);const c=document.createElement("button");c.className="author-btn",c.textContent=a;let f=this.authors.indexOf(a);f===-1&&(f=0),console.log(e),console.log(i),e===i?c.addEventListener("click",()=>{f=(f+1)%this.authors.length,c.textContent=this.authors[f]}):(c.disabled=!0,c.title="Вы не можете менять автора этой заметки");const p=document.createElement("div");p.style.display="flex",p.style.justifyContent="flex-end",p.style.marginBottom="4px",p.appendChild(c);const l=document.createElement("div");l.setAttribute("contenteditable","true"),l.setAttribute("spellcheck","false"),l.classList.add("outline-none"),l.textContent=r,l.addEventListener("blur",()=>{this.sendNoteUpdate(n)});const h=document.createElement("button");return h.textContent="×",h.title="Удалить заметку",h.type="button",h.className="delete-btn",e===i?h.addEventListener("click",g=>{g.stopPropagation();const v=n.getAttribute("data-id");v&&this.deleteNoteFromServer(v),n.remove()}):(h.disabled=!0,h.title="Вы не можете удалить заметку, вы ее не создавали"),n.appendChild(p),n.appendChild(l),n.appendChild(h),n.addEventListener("mousedown",g=>this.onMouseDown(g,n)),n.addEventListener("click",g=>{g.target.classList.contains("delete-btn")||l.focus()}),this.noteBoard.appendChild(n),this.observeNoteResize(n),typeof o=="function"&&o(n,{text:l.textContent,color:n.style.backgroundColor,position_top:parseFloat(n.style.top),position_left:parseFloat(n.style.left),author:c.textContent}),n}addNoteCard(t){const o=this.noteBoard.getBoundingClientRect(),e=o.height/2-50,s=o.width/2-140;this.buildNoteCard({text:"Новая заметка...",color:t||"#FFEB3B",position_top:e,position_left:s,author:this.authors[this.currentAuthorIndex]},(d,m)=>{this.sendNoteToServer(m,u=>{d.setAttribute("data-id",u.id),d.setAttribute("data-id",u.user)})},username).querySelector("[contenteditable]").focus()}createNoteFromData(t){this.buildNoteCard(t,void 0,username)}sendNoteUpdate(t){const o=t.getAttribute("data-id"),e=t.querySelector("[contenteditable]").textContent,s=t.style.backgroundColor,r=parseInt(t.style.top,10),d=parseInt(t.style.left,10),m=t.querySelector("button").textContent,u={id:o,text:e,color:s,position_top:r,position_left:d,author:m};fetch("",{method:"PATCH",headers:{"Content-Type":"application/json","X-CSRFToken":this.csrfToken},body:JSON.stringify(u)}).then(async a=>{const i=await a.json();if(!a.ok)throw console.log(i),new Error(i.error||JSON.stringify(i.errors)||"Ошибка при обновлении заметки");return i}).then(a=>{console.log("Заметка обновлена:",a),this.showSuccessMessage(`Заметка с текстом "${a.note.text}" обновлена`)}).catch(a=>{console.error("Ошибка:",a.message),k(a.message)})}sendNoteToServer(t,o){fetch("",{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":this.csrfToken},body:JSON.stringify(t)}).then(e=>{if(!e.ok)throw new Error("Ошибка при создании заметки");return e.json()}).then(e=>{console.log("Заметка создана:",e),typeof o=="function"&&o(e.note),this.showSuccessMessage(`Заметка создана: ${e.note.text} `)}).catch(e=>{console.error("Ошибка отправки:",e)})}deleteNoteFromServer(t){fetch(`${t}`,{method:"DELETE",headers:{"X-CSRFToken":this.csrfToken}}).then(o=>o.json().then(e=>{if(!o.ok)throw new Error(e.error||"Ошибка при удалении заметки");return e})).then(o=>{this.showSuccessMessage(o.message||`Заметка с ID ${t} успешно удалена с сервера`),console.log(`Заметка с ID ${t} успешно удалена с сервера`)}).catch(o=>{console.error("Ошибка при удалении:",o.message),k(o)})}showSuccessMessage(t){const o=document.getElementById("server-info");o.classList.remove("hidden","animate-popup-reverse"),o.classList.add("flex","animate-popup"),o.querySelector("p").textContent=t,o.scrollIntoView({behavior:"smooth",block:"start"}),setTimeout(()=>{o.classList.remove("animate-popup"),o.classList.add("animate-popup-reverse"),setTimeout(()=>{o.classList.add("hidden"),o.classList.remove("flex","animate-popup-reverse")},1e3)},5e3)}}class C{constructor({addButtonId:t,boardId:o}){this.taskIdCounter=1,this.addTaskBtn=document.getElementById(t),this.taskBoard=document.getElementById(o),this.addTaskBtn.addEventListener("click",()=>this.addTaskCard()),this.taskBoard.addEventListener("click",e=>{e.target.classList.contains("delete-btn")&&e.target.closest(".task-card").remove()}),this.taskBoard.addEventListener("change",e=>{if(e.target.type==="checkbox"&&e.target.closest(".task-card")){const s=e.target.closest(".task-card");e.target.checked?s.classList.add("task-completed"):s.classList.remove("task-completed")}})}addTaskCard(){const t=document.createElement("div");t.classList.add("task-card","bg-white","p-4","rounded","shadow","relative","flex","flex-col","border-l-20","border-l-lime-500","rounded-xl"),t.setAttribute("data-id",this.taskIdCounter++),t.innerHTML=`
      <h3 contenteditable="true" class="text-lg font-semibold mb-1" spellcheck="false">Новая задача</h3>
      <p contenteditable="true" class="text-sm text-gray-600 flex-grow" spellcheck="false">Описание...</p>
      <div class="mt-2 text-xs text-gray-400">Срок: <input type="date" class="task-deadline border border-gray-300 rounded p-1 text-xs" /></div>
      <button class="delete-btn absolute top-2 right-2 text-red-500 hover:text-red-700" title="Удалить задачу">×</button>
    `,this.taskBoard.appendChild(t),t.querySelector("h3").focus()}}document.addEventListener("DOMContentLoaded",()=>{y("a-stickers","a-stickers-mob"),new x({addButtonId:"add-card",boardId:"note-board",colors:["#FFEB3B","#FFCDD2","#C8E6C9","#BBDEFB"]}).loadInitialNotes(),new C({addButtonId:"btn-tasks",boardId:"task-board"})});
